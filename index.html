<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HLS ABR Player with Fallback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height:100%; margin:0; background:#000; }
    #wrap { display:flex; align-items:center; justify-content:center; height:100%; padding:12px; }
    video { width: min(100vw, 960px); height: auto; background:#000; }
    .note { color:#bbb; font:14px/1.4 system-ui, sans-serif; margin-top:8px; text-align:center; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
  <div id="wrap">
    <div>
      <video id="video" controls playsinline>
        <!-- Browser-native fallbacks if HLS.js cannot run -->
        <source id="mp4Fallback" src="fallback-720p.mp4" type="video/mp4" />
        <source id="webmFallback" src="fallback-720p.webm" type="video/webm" />
        <!-- Optional: a final text fallback -->
        Sorry, this browser does not support embedded video.
      </video>
      <div class="note">If the HLS stream cannot play, the player will try MP4/WebM fallbacks above.</div>
    </div>
  </div>

  <script>
    const hlsUrl = "https://sonymtpristinenew.akamaized.net/hls/live/2119921/cricacc12409/HIN/std_lrh-800300010_1080_4140000.m3u8";
    const video = document.getElementById("video");

    async function tryHls() {
      // Native HLS (Safari/iOS)
      if (video.canPlayType("application/vnd.apple.mpegurl")) {
        video.src = hlsUrl;
        await video.play().catch(()=>{});
        return true;
      }
      // hls.js on MSE browsers (Chrome/Firefox/Edge/Android)
      if (window.Hls && Hls.isSupported()) {
        const hls = new Hls({
          // Enable ABR
          abrEwmaDefaultEstimate: 5000000,   // starting estimate
          maxBufferLength: 30,
          lowLatencyMode: true
        });
        hls.loadSource(hlsUrl);
        hls.attachMedia(video);
        hls.on(Hls.Events.ERROR, (evt, data) => {
          if (data.fatal) {
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                hls.recoverMediaError();
                break;
              default:
                hls.destroy();
            }
          }
        });
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          // hls.js ABR automatically selects best level; no manual action needed
          video.play().catch(()=>{});
        });
        return true;
      }
      return false;
    }

    (async () => {
      const ok = await tryHls();
      if (!ok) {
        // Let browser attempt the <source> fallbacks (MP4/WebM)
        // Optionally: choose one via canPlayType or HEAD check before play
        video.load();
        video.play().catch(()=>{});
      }

      // Optional: runtime fallback if HLS errors later
      video.addEventListener('error', () => {
        // Switch to first fallback source programmatically if HLS was set
        const mp4 = document.getElementById('mp4Fallback');
        if (mp4 && mp4.src) {
          video.src = mp4.src;
          video.load();
          video.play().catch(()=>{});
        }
      }, true);
    })();
  </script>
</body>
</html>
